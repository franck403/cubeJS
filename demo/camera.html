<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Camera Stream</title>
  <style>
    body { font-family:sans-serif; margin:0; text-align:center; }
    video { width:100%; height:auto; background:#000; }
    select, button { margin:5px; padding:6px; font-size:16px; }
  </style>
</head>
<body>
  <video id="preview" autoplay playsinline></video>
  <br>
  <select id="videoSelect"></select>
  <select id="audioSelect"></select>
  <button id="applyBtn">Apply</button>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init()</script>
  <script src="../plugin.js"></script>
  <script src="peerPlugin.js"></script>
  <script>
    const urlParams = new URLSearchParams(location.search);
    const id = urlParams.get("id") || "camera1";
    console.log("Peer ID:", id);
    const video = document.getElementById("preview");
    const videoSelect = document.getElementById("videoSelect");
    const audioSelect = document.getElementById("audioSelect");
    const applyBtn = document.getElementById("applyBtn");
    let currentStream = null;
    const peer = new Peer(id, { host: location.hostname, port: 8081, path: "/peerjs" });
  
    // Load saved settings for the current id
    function loadSettings() {
      const saved = localStorage.getItem(`settings_${id}`);
      if (saved) {
        const { videoId, audioId } = JSON.parse(saved);
        videoSelect.value = videoId || "";
        audioSelect.value = audioId || "";
        return { videoId, audioId };
      }
      return { videoId: null, audioId: null };
    }
  
    // Save settings to localStorage
    function saveSettings(videoId, audioId) {
      localStorage.setItem(`settings_${id}`, JSON.stringify({ videoId, audioId }));
    }
  
    // List available devices
    async function listDevices() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        videoSelect.innerHTML = "";
        audioSelect.innerHTML = "";
        devices.forEach(d => {
          if (d.kind === "videoinput") {
            const opt = document.createElement("option");
            opt.value = d.deviceId;
            opt.textContent = d.label || `Camera ${videoSelect.length + 1}`;
            videoSelect.appendChild(opt);
          } else if (d.kind === "audioinput") {
            const opt = document.createElement("option");
            opt.value = d.deviceId;
            opt.textContent = d.label || `Microphone ${audioSelect.length + 1}`;
            audioSelect.appendChild(opt);
          }
        });
        const { videoId, audioId } = loadSettings();
        if (videoId || audioId) {
          startStream(videoId, audioId);
        } else if (devices.some(d => d.kind === "videoinput")) {
          // If no saved settings, start with the first camera
          startStream(devices.find(d => d.kind === "videoinput").deviceId, null);
        }
      } catch (err) {
        console.error("Error enumerating devices:", err);
      }
    }
  
    // Start stream with selected devices
    async function startStream(videoId, audioId) {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }
      const constraints = {
        video: videoId ? { deviceId: { exact: videoId } } : true,
        audio: audioId ? { deviceId: { exact: audioId } } : true
      };
      try {
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;
        // Reattach call handler with the new stream
        if (peer) {
          peer.off("call");
          peer.on("call", (call) => {
            console.log("Answering call with current stream");
            call.answer(currentStream);
          });
        }
        saveSettings(videoId, audioId);
      } catch (err) {
        console.error("Error accessing media devices:", err);
      }
    }
  
    // Apply button click handler
    applyBtn.onclick = () => {
      startStream(videoSelect.value, audioSelect.value);
    };
  
    // Initialize
    peer.on("open", () => {
      console.log("Peer connection opened");
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          currentStream = stream;
          video.srcObject = stream;
          listDevices();
          // Attach call handler for the first time
          peer.on("call", (call) => {
            console.log("Answering initial call with current stream");
            call.answer(currentStream);
          });
        })
        .catch(err => {
          console.error("Error accessing initial media devices:", err);
        });
    });
  </script>
  
  
  
</body>
</html>
